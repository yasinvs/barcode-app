<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AkÄ±llÄ± Barkod TarayÄ±cÄ±</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 20px; background: #f0f2f5; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); position: relative; }
        h2 { text-align: center; color: #333; margin-top: 0; }
        
        /* Kontrol AlanÄ± */
        .controls { margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        select, input { padding: 12px; width: 60%; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; }
        button { padding: 12px 15px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 14px; }
        button:active { transform: scale(0.98); }
        button.delete { background: #dc3545; float: right; }
        button.export { background: #28a745; width: 100%; margin-top: 15px; font-size: 1.1em; }
        
        /* Kamera AlanÄ± */
        #reader { width: 100%; margin-bottom: 20px; border-radius: 8px; overflow: hidden; border: 1px solid #ccc; }
        
        /* Liste AlanÄ± */
        #scan-list { list-style: none; padding: 0; max-height: 300px; overflow-y: auto; border: 1px solid #eee; border-radius: 6px; }
        #scan-list li { padding: 12px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        #scan-list li:nth-child(odd) { background: #fafafa; }
        .timestamp { font-size: 0.8em; color: #999; margin-left: 10px; }

        /* Bildirim Kutusu (Toast) */
        #notification {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 50px;
            padding: 16px;
            position: fixed;
            z-index: 1000;
            left: 50%;
            top: 30px;
            transform: translateX(-50%);
            font-size: 16px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            opacity: 0;
            transition: opacity 0.3s, top 0.3s;
        }
        #notification.show { visibility: visible; opacity: 1; top: 50px; }
        #notification.success { background-color: #28a745; } /* YeÅŸil */
        #notification.error { background-color: #dc3545; }   /* KÄ±rmÄ±zÄ± */
    </style>
</head>
<body>

<div id="notification">Bildirim</div>

<div class="container">
    <h2>ðŸ“¦ Depo SayÄ±m V2</h2>

    <div class="controls">
        <label>Aktif KlasÃ¶r:</label><br>
        <select id="folderSelect" onchange="loadScans()"></select>
        <button onclick="deleteFolder()" class="delete">Sil</button>
        <br><br>
        <input type="text" id="newFolderInput" placeholder="Yeni KlasÃ¶r AdÄ±">
        <button onclick="addFolder()">+ Ekle</button>
    </div>

    <div id="reader"></div>

    <button onclick="exportToCSV()" class="export">ðŸ“‚ CSV Ä°ndir (<span id="folderNameDisplay"></span>)</button>

    <h3>Son Okunanlar (<span id="count">0</span>)</h3>
    <ul id="scan-list"></ul>
</div>

<script>
    // --- 1. Veri YÃ¶netimi ---
    let folders = JSON.parse(localStorage.getItem('folders')) || ['Genel'];
    let scans = JSON.parse(localStorage.getItem('scans')) || []; 
    let currentFolder = folders[0];
    
    // Spam korumasÄ± iÃ§in son okunanÄ± hafÄ±zada tutuyoruz
    let lastScannedCode = null;
    let scanCooldown = false;

    // --- 2. BaÅŸlatma ---
    function init() {
        const select = document.getElementById('folderSelect');
        select.innerHTML = '';
        folders.forEach(f => {
            let opt = document.createElement('option');
            opt.value = f;
            opt.innerText = f;
            if(f === currentFolder) opt.selected = true;
            select.appendChild(opt);
        });
        loadScans();
    }

    // --- 3. Kamera AyarlarÄ± ---
    const html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
    
    function onScanSuccess(decodedText, decodedResult) {
        // EÄŸer cooldown aktifse veya aynÄ± kodu peÅŸ peÅŸe (milisaniyeler iÃ§inde) okuyorsa iÅŸlem yapma
        if (scanCooldown) return;

        // Cooldown'Ä± baÅŸlat (1.5 saniye bekleme)
        scanCooldown = true;
        setTimeout(() => { scanCooldown = false; }, 1500);

        currentFolder = document.getElementById('folderSelect').value;

        // --- DUPLICATE KONTROLÃœ BURADA ---
        // Sadece ÅžU ANKÄ° klasÃ¶rde bu barkod var mÄ± diye bakÄ±yoruz.
        const exists = scans.some(s => s.folder === currentFolder && s.code === decodedText);

        if (exists) {
            showToast(`âš ï¸ Bu barkod zaten var: ${decodedText}`, "error");
            // TitreÅŸim (Mobil cihaz destekliyorsa)
            if(navigator.vibrate) navigator.vibrate(200); 
        } else {
            // Yoksa Ekle
            const newScan = {
                folder: currentFolder,
                code: decodedText,
                time: new Date().toLocaleString('tr-TR')
            };
            
            scans.unshift(newScan);
            localStorage.setItem('scans', JSON.stringify(scans));
            loadScans();
            
            showToast(`âœ… Eklendi: ${decodedText}`, "success");
            if(navigator.vibrate) navigator.vibrate(50);
        }
    }
    
    html5QrcodeScanner.render(onScanSuccess);

    // --- 4. YardÄ±mcÄ± Fonksiyonlar ---

    // Ekrana ÅžÄ±k Bildirim Ã‡Ä±karma
    function showToast(message, type) {
        const x = document.getElementById("notification");
        x.className = "show " + type;
        x.innerText = message;
        
        // 2 saniye sonra kaybolsun
        setTimeout(function(){ 
            x.className = x.className.replace("show", ""); 
        }, 2000);
    }

    function addFolder() {
        const input = document.getElementById('newFolderInput');
        const name = input.value.trim();
        if (name && !folders.includes(name)) {
            folders.push(name);
            localStorage.setItem('folders', JSON.stringify(folders));
            currentFolder = name;
            input.value = '';
            init();
            showToast("KlasÃ¶r oluÅŸturuldu", "success");
        } else {
            alert("GeÃ§ersiz veya mevcut klasÃ¶r adÄ±!");
        }
    }

    function deleteFolder() {
        const select = document.getElementById('folderSelect');
        const folderToDelete = select.value;
        if(confirm(folderToDelete + " klasÃ¶rÃ¼ silinecek? Veriler kaybolur.")) {
            folders = folders.filter(f => f !== folderToDelete);
            scans = scans.filter(s => s.folder !== folderToDelete);
            
            if(folders.length === 0) folders = ['Genel'];
            currentFolder = folders[0];
            
            localStorage.setItem('folders', JSON.stringify(folders));
            localStorage.setItem('scans', JSON.stringify(scans));
            init();
            showToast("KlasÃ¶r silindi", "error");
        }
    }

    function loadScans() {
        currentFolder = document.getElementById('folderSelect').value;
        document.getElementById('folderNameDisplay').innerText = currentFolder;

        const list = document.getElementById('scan-list');
        list.innerHTML = '';
        
        const filteredScans = scans.filter(s => s.folder === currentFolder);
        document.getElementById('count').innerText = filteredScans.length;

        filteredScans.forEach(s => {
            let li = document.createElement('li');
            li.innerHTML = `<strong>${s.code}</strong> <span class="timestamp">${s.time}</span>`;
            list.appendChild(li);
        });
    }

    function exportToCSV() {
        currentFolder = document.getElementById('folderSelect').value;
        const filteredScans = scans.filter(s => s.folder === currentFolder);
        
        if(filteredScans.length === 0) { alert("Bu klasÃ¶r boÅŸ!"); return; }

        // CSV BOM ekleyerek TÃ¼rkÃ§e karakter sorununu Ã§Ã¶zelim (\uFEFF)
        let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
        csvContent += "Barkod;Tarih;KlasÃ¶r\r\n";

        filteredScans.forEach(row => {
            csvContent += `${row.code};${row.time};${row.folder}\r\n`;
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `Barkodlar_${currentFolder}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    init();
</script>

</body>
</html>