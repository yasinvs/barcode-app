<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Benim Barkod TarayÄ±cÄ±m</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f4f4; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #333; }
        
        /* Kontrol AlanÄ± */
        .controls { margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        select, input { padding: 10px; width: 60%; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; }
        button { padding: 10px 15px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        button.delete { background: #dc3545; }
        button.export { background: #28a745; width: 100%; margin-top: 10px; font-size: 1.1em; }
        
        /* Kamera AlanÄ± */
        #reader { width: 100%; margin-bottom: 20px; border: 1px solid #ccc; }
        
        /* Liste AlanÄ± */
        #scan-list { list-style: none; padding: 0; max-height: 300px; overflow-y: auto; border: 1px solid #eee; }
        #scan-list li { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        #scan-list li:nth-child(odd) { background: #fafafa; }
        .timestamp { font-size: 0.8em; color: #666; margin-left: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h2>ðŸ“¦ Depo Barkod Sistemi</h2>

    <div class="controls">
        <label>Aktif KlasÃ¶r:</label><br>
        <select id="folderSelect" onchange="loadScans()"></select>
        <button onclick="deleteFolder()" class="delete" style="float:right;">Sil</button>
        <br><br>
        <input type="text" id="newFolderInput" placeholder="Yeni KlasÃ¶r AdÄ± (Ã–rn: Raf-1)">
        <button onclick="addFolder()">+ Ekle</button>
    </div>

    <div id="reader"></div>

    <button onclick="exportToCSV()" class="export">ðŸ“‚ SeÃ§ili KlasÃ¶rÃ¼ CSV Ä°ndir</button>

    <h3>Son Okunanlar (<span id="count">0</span>)</h3>
    <ul id="scan-list"></ul>
</div>

<script>
    // --- 1. Veri ve Ayarlar ---
    let folders = JSON.parse(localStorage.getItem('folders')) || ['Genel'];
    let scans = JSON.parse(localStorage.getItem('scans')) || []; // {folder: 'Genel', code: '123', time: '...'}
    let currentFolder = folders[0];

    // --- 2. BaÅŸlangÄ±Ã§ YÃ¼klemeleri ---
    function init() {
        const select = document.getElementById('folderSelect');
        select.innerHTML = '';
        folders.forEach(f => {
            let opt = document.createElement('option');
            opt.value = f;
            opt.innerText = f;
            if(f === currentFolder) opt.selected = true;
            select.appendChild(opt);
        });
        loadScans();
    }

    // --- 3. TarayÄ±cÄ±yÄ± BaÅŸlat ---
    const html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
    
    function onScanSuccess(decodedText, decodedResult) {
        // AynÄ± barkodu Ã¼st Ã¼ste okumasÄ±nÄ± engellemek istersen buraya kontrol koyabiliriz.
        // Åžimdilik her okuduÄŸunu ekliyor.
        
        const newScan = {
            folder: document.getElementById('folderSelect').value,
            code: decodedText,
            time: new Date().toLocaleString('tr-TR')
        };
        
        scans.unshift(newScan); // En baÅŸa ekle
        localStorage.setItem('scans', JSON.stringify(scans));
        loadScans();
        
        // Sesli geri bildirim (Bip sesi)
        // alert("Okundu: " + decodedText); // Ä°stersen aÃ§abilirsin
    }
    
    html5QrcodeScanner.render(onScanSuccess);

    // --- 4. Fonksiyonlar ---

    function addFolder() {
        const input = document.getElementById('newFolderInput');
        const name = input.value.trim();
        if (name && !folders.includes(name)) {
            folders.push(name);
            localStorage.setItem('folders', JSON.stringify(folders));
            currentFolder = name;
            input.value = '';
            init();
        } else {
            alert("GeÃ§ersiz veya mevcut klasÃ¶r adÄ±!");
        }
    }

    function deleteFolder() {
        const select = document.getElementById('folderSelect');
        const folderToDelete = select.value;
        if(confirm(folderToDelete + " klasÃ¶rÃ¼ ve iÃ§indeki tÃ¼m veriler silinecek?")) {
            folders = folders.filter(f => f !== folderToDelete);
            // O klasÃ¶re ait scanleri de temizle
            scans = scans.filter(s => s.folder !== folderToDelete);
            
            if(folders.length === 0) folders = ['Genel'];
            currentFolder = folders[0];
            
            localStorage.setItem('folders', JSON.stringify(folders));
            localStorage.setItem('scans', JSON.stringify(scans));
            init();
        }
    }

    function loadScans() {
        currentFolder = document.getElementById('folderSelect').value;
        const list = document.getElementById('scan-list');
        list.innerHTML = '';
        
        // Sadece aktif klasÃ¶re ait verileri filtrele
        const filteredScans = scans.filter(s => s.folder === currentFolder);
        document.getElementById('count').innerText = filteredScans.length;

        filteredScans.forEach(s => {
            let li = document.createElement('li');
            li.innerHTML = `<strong>${s.code}</strong> <span class="timestamp">${s.time}</span>`;
            list.appendChild(li);
        });
    }

    function exportToCSV() {
        currentFolder = document.getElementById('folderSelect').value;
        const filteredScans = scans.filter(s => s.folder === currentFolder);
        
        if(filteredScans.length === 0) { alert("Bu klasÃ¶r boÅŸ!"); return; }

        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "Barkod;Tarih;KlasÃ¶r\r\n"; // BaÅŸlÄ±klar

        filteredScans.forEach(row => {
            csvContent += `${row.code};${row.time};${row.folder}\r\n`;
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `Barkodlar_${currentFolder}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // BaÅŸlat
    init();
</script>

</body>
</html>