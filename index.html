<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Barkod Master Hibrit</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007bff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        :root {
            --bg-color: #f0f2f5; --card-bg: #ffffff; --text-color: #333333;
            --border-color: #eeeeee; --item-bg-odd: #fafafa; --highlight: #007bff;
        }
        [data-theme="dark"] {
            --bg-color: #121212; --card-bg: #1e1e1e; --text-color: #e0e0e0;
            --border-color: #333333; --item-bg-odd: #252525; --highlight: #4dabf7;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 15px; background: var(--bg-color); color: var(--text-color); transition: 0.3s; user-select: none; }
        .container { max-width: 600px; margin: 0 auto; background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        
        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        h2 { margin: 0; font-size: 1.4em; }
        .theme-toggle { background: none; border: 1px solid var(--text-color); color: var(--text-color); padding: 5px 10px; border-radius: 20px; cursor: pointer; }

        /* Controls */
        .controls { margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; }
        select, input[type="text"] { padding: 10px; width: 100%; margin-bottom: 10px; background: var(--bg-color); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 6px; box-sizing: border-box; }
        .row { display: flex; gap: 10px; }
        
        /* Checkbox Stili */
        .checkbox-container { display: flex; align-items: center; margin-bottom: 10px; padding: 10px; background: var(--item-bg-odd); border-radius: 8px; border: 1px solid var(--border-color); }
        .checkbox-container input { width: 20px; height: 20px; margin-right: 10px; cursor: pointer; }
        .checkbox-container label { font-weight: bold; cursor: pointer; flex: 1; }

        button { padding: 12px; background: var(--highlight); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; flex: 1; }
        button.delete-folder { background: #dc3545; flex: 0.4; }
        button.export { background: #28a745; width: 100%; margin-top: 10px; }
        button.backup { background: #6c757d; }
        button.restore { background: #17a2b8; }

        /* Kamera */
        #reader { width: 100%; margin-bottom: 15px; border-radius: 8px; overflow: hidden; background: black; }

        /* Arama */
        #searchInput { padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 16px; margin-top: 10px;}

        /* Liste */
        #scan-list { list-style: none; padding: 0; max-height: 350px; overflow-y: auto; }
        #scan-list li { padding: 12px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        
        .item-left { display: flex; align-items: center; gap: 10px; }
        .qty-badge { background: var(--highlight); color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.9em; font-weight: bold; min-width: 20px; text-align: center; }
        .code-text { font-weight: bold; font-size: 1.1em; display: block; }
        .timestamp { font-size: 0.75em; opacity: 0.7; }

        .btn-controls { display: flex; gap: 5px; }
        .btn-small { padding: 5px 10px; font-size: 14px; border-radius: 4px; }
        .btn-plus { background: var(--highlight); }
        .btn-minus { background: #ffc107; color: black; }
        .btn-del { background: #dc3545; }

        /* Toast */
        #notification { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 50px; padding: 16px; position: fixed; z-index: 1000; left: 50%; top: 30px; transform: translateX(-50%); opacity: 0; transition: 0.3s; }
        #notification.show { visibility: visible; opacity: 1; top: 50px; }
        #notification.success { background-color: #28a745; }
        #notification.update { background-color: #17a2b8; } 
        #notification.error { background-color: #dc3545; }
    </style>
</head>
<body>

<div id="notification">Bildirim</div>

<div class="container">
    <div class="header">
        <h2>üì¶ Barkod Master <small>v3</small></h2>
        <button class="theme-toggle" onclick="toggleTheme()">üåô</button>
    </div>

    <div class="controls">
        <div class="row">
            <select id="folderSelect" onchange="loadScans()"></select>
            <button onclick="deleteFolder()" class="delete-folder">üóëÔ∏è</button>
        </div>
        
        <div class="checkbox-container">
            <input type="checkbox" id="allowDuplicates" onchange="saveCheckboxState()">
            <label for="allowDuplicates">Yinelenenleri Ekle (Adet Modu)</label>
        </div>

        <div class="row">
            <input type="text" id="newFolderInput" placeholder="Yeni Klas√∂r (√ñrn: Raf_A)">
            <button onclick="addFolder()">+ Klas√∂r</button>
        </div>
    </div>

    <div id="reader"></div>

    <input type="text" id="searchInput" placeholder="üîç Barkod Ara..." onkeyup="filterList()">

    <button onclick="exportToCSV()" class="export">üìÇ Excel/CSV ƒ∞ndir</button>

    <div class="row" style="margin-top:10px">
        <button onclick="backupData()" class="backup">üíæ Yedek Al</button>
        <button onclick="document.getElementById('restoreInput').click()" class="restore">‚ôªÔ∏è Geri Y√ºkle</button>
        <input type="file" id="restoreInput" style="display:none" onchange="restoreData(this)">
    </div>

    <h3>√úr√ºnler (<span id="count">0</span>)</h3>
    <ul id="scan-list"></ul>
</div>

<script>
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if ('serviceWorker' in navigator) { window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js')); }

    let folders = JSON.parse(localStorage.getItem('folders')) || ['Genel'];
    let scans = JSON.parse(localStorage.getItem('scans')) || []; 
    let currentFolder = folders[0];
    let scanCooldown = false;

    // Ayarlarƒ± Y√ºkle
    if (localStorage.getItem('theme') === 'dark') { document.body.setAttribute('data-theme', 'dark'); }
    
    // Checkbox durumunu y√ºkle (Varsayƒ±lan: True/Se√ßili)
    const savedCheckbox = localStorage.getItem('allowDuplicates');
    document.getElementById('allowDuplicates').checked = savedCheckbox !== 'false';

    function init() {
        const select = document.getElementById('folderSelect');
        select.innerHTML = '';
        folders.forEach(f => {
            let opt = document.createElement('option');
            opt.value = f; opt.innerText = f;
            if(f === currentFolder) opt.selected = true;
            select.appendChild(opt);
        });
        loadScans();
    }

    const html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
    
    function onScanSuccess(decodedText, decodedResult) {
        if (scanCooldown) return;
        scanCooldown = true;
        setTimeout(() => { scanCooldown = false; }, 1200);

        currentFolder = document.getElementById('folderSelect').value;
        const allowDuplicates = document.getElementById('allowDuplicates').checked; // Checkbox durumu
        
        const existingIndex = scans.findIndex(s => s.folder === currentFolder && s.code === decodedText);

        if (existingIndex !== -1) {
            // --- √úR√úN ZATEN VAR ---
            if (allowDuplicates) {
                // Mod A√áIK: Adet Artƒ±r
                scans[existingIndex].qty = (scans[existingIndex].qty || 1) + 1;
                scans[existingIndex].time = new Date().toLocaleString('tr-TR');
                
                // Ba≈üa ta≈üƒ±
                const updatedItem = scans.splice(existingIndex, 1)[0];
                scans.unshift(updatedItem);
                
                showToast(`üì¶ Adet Arttƒ±: ${decodedText} (x${updatedItem.qty})`, "update");
                playBeep(600);
            } else {
                // Mod KAPALI: Hata Ver
                showToast(`‚ö†Ô∏è HATA: Bu √ºr√ºn zaten var! (${decodedText})`, "error");
                if(navigator.vibrate) navigator.vibrate([100, 50, 100]); // Hata titre≈üimi
                return; // Kaydetme ve √ßƒ±k
            }
        } else {
            // --- YENƒ∞ √úR√úN ---
            const newScan = {
                folder: currentFolder,
                code: decodedText,
                time: new Date().toLocaleString('tr-TR'),
                qty: 1
            };
            scans.unshift(newScan);
            showToast(`‚úÖ Yeni √úr√ºn: ${decodedText}`, "success");
            playBeep(880);
        }
        
        saveData();
        loadScans();
        if(navigator.vibrate && (existingIndex === -1 || allowDuplicates)) navigator.vibrate(100);
    }
    
    html5QrcodeScanner.render(onScanSuccess);

    // --- Fonksiyonlar ---
    
    function saveCheckboxState() {
        const isChecked = document.getElementById('allowDuplicates').checked;
        localStorage.setItem('allowDuplicates', isChecked);
    }

    function updateQty(code, change) {
        const index = scans.findIndex(s => s.folder === currentFolder && s.code === code);
        if (index !== -1) {
            scans[index].qty = (scans[index].qty || 1) + change;
            if (scans[index].qty <= 0) {
                if(confirm("Adet 0 oldu, silinsin mi?")) { scans.splice(index, 1); } 
                else { scans[index].qty = 1; }
            }
            saveData(); loadScans();
        }
    }

    function deleteItem(code) {
        if(confirm(`"${code}" tamamen silinsin mi?`)) {
            scans = scans.filter(s => !(s.folder === currentFolder && s.code === code));
            saveData(); loadScans();
        }
    }

    function loadScans() {
        currentFolder = document.getElementById('folderSelect').value;
        const list = document.getElementById('scan-list');
        list.innerHTML = '';
        
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const filteredScans = scans.filter(s => 
            s.folder === currentFolder && 
            s.code.toLowerCase().includes(searchTerm)
        );

        document.getElementById('count').innerText = filteredScans.length;

        filteredScans.forEach(s => {
            const qty = s.qty || 1;
            let li = document.createElement('li');
            li.innerHTML = `
                <div class="item-left">
                    <span class="qty-badge">x${qty}</span>
                    <div class="item-info">
                        <span class="code-text">${s.code}</span>
                        <span class="timestamp">${s.time}</span>
                    </div>
                </div>
                <div class="btn-controls">
                    <button onclick="updateQty('${s.code}', 1)" class="btn-small btn-plus">+</button>
                    <button onclick="updateQty('${s.code}', -1)" class="btn-small btn-minus">-</button>
                    <button onclick="deleteItem('${s.code}')" class="btn-small btn-del">üóëÔ∏è</button>
                </div>
            `;
            list.appendChild(li);
        });
    }

    function filterList() { loadScans(); }

    function exportToCSV() {
        currentFolder = document.getElementById('folderSelect').value;
        const filteredScans = scans.filter(s => s.folder === currentFolder);
        if(filteredScans.length === 0) { alert("Klas√∂r bo≈ü!"); return; }
        
        let csvContent = "data:text/csv;charset=utf-8,\uFEFFBarkod;Adet;Son_Islem_Tarihi;Klas√∂r\r\n";
        filteredScans.forEach(row => {
            csvContent += `${row.code};${row.qty || 1};${row.time};${row.folder}\r\n`;
        });
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.href = encodedUri; link.download = `Stok_${currentFolder}.csv`;
        document.body.appendChild(link); link.click(); document.body.removeChild(link);
    }

    function saveData() { localStorage.setItem('scans', JSON.stringify(scans)); localStorage.setItem('folders', JSON.stringify(folders)); }
    function addFolder() { 
        const name = document.getElementById('newFolderInput').value.trim();
        if (name && !folders.includes(name)) { folders.push(name); saveData(); currentFolder=name; document.getElementById('newFolderInput').value=''; init(); } 
    }
    function deleteFolder() { if(confirm("Klas√∂r silinsin mi?")) { folders = folders.filter(f=>f!==document.getElementById('folderSelect').value); scans=scans.filter(s=>s.folder!==currentFolder); if(folders.length===0) folders=['Genel']; currentFolder=folders[0]; saveData(); init(); } }
    function backupData() {
        const blob = new Blob([JSON.stringify({folders, scans})], {type: "application/json"});
        const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = "Yedek.json"; document.body.appendChild(link); link.click(); document.body.removeChild(link);
    }
    function restoreData(input) {
        const file = input.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = e => { try { const d=JSON.parse(e.target.result); folders=d.folders; scans=d.scans; saveData(); init(); showToast("Y√ºklendi!","success"); } catch(err){alert("Hata");} };
        reader.readAsText(file);
    }
    function playBeep(freq) {
        if(audioCtx.state==='suspended') audioCtx.resume();
        const o=audioCtx.createOscillator(); const g=audioCtx.createGain();
        o.connect(g); g.connect(audioCtx.destination);
        o.type="square"; o.frequency.value=freq; g.gain.value=0.1;
        o.start(); setTimeout(()=>o.stop(), 150);
    }
    function showToast(msg, type) { const x=document.getElementById("notification"); x.className="show "+type; x.innerText=msg; setTimeout(()=>x.className="", 2000); }
    function toggleTheme() {
        if(document.body.getAttribute('data-theme')==='dark') { document.body.removeAttribute('data-theme'); localStorage.setItem('theme','light'); } 
        else { document.body.setAttribute('data-theme','dark'); localStorage.setItem('theme','dark'); }
    }

    init();
</script>
</body>
</html>