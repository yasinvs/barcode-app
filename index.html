<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Barkod Master v9 (Clean)</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007bff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        :root {
            --bg-color: #f0f2f5; --card-bg: #ffffff; --text-color: #333333;
            --border-color: #eeeeee; --item-bg-odd: #fafafa; --highlight: #007bff;
        }
        [data-theme="dark"] {
            --bg-color: #121212; --card-bg: #1e1e1e; --text-color: #e0e0e0;
            --border-color: #333333; --item-bg-odd: #252525; --highlight: #4dabf7;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 15px; background: var(--bg-color); color: var(--text-color); transition: 0.3s; user-select: none; }
        .container { max-width: 600px; margin: 0 auto; background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        h2 { margin: 0; font-size: 1.4em; }
        .theme-toggle { background: none; border: 1px solid var(--text-color); color: var(--text-color); padding: 5px 10px; border-radius: 20px; cursor: pointer; }

        .controls { margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; }
        select, input[type="text"], input[type="number"], input[type="password"] { padding: 10px; width: 100%; margin-bottom: 10px; background: var(--bg-color); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 6px; box-sizing: border-box; }
        .row { display: flex; gap: 10px; margin-bottom: 10px; }
        
        .checkbox-container { display: flex; align-items: center; margin-bottom: 10px; padding: 10px; background: var(--item-bg-odd); border-radius: 8px; border: 1px solid var(--border-color); }
        .checkbox-container input { width: 20px; height: 20px; margin-right: 10px; cursor: pointer; }
        .checkbox-container label { font-weight: bold; cursor: pointer; flex: 1; }

        button { padding: 12px; background: var(--highlight); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; flex: 1; font-size: 14px; }
        button:active { transform: scale(0.98); }
        button.delete-folder { background: #dc3545; flex: 0.3; }
        button.clear-list { background: #ffc107; color: black; flex: 0.3; }
        button.export { background: #28a745; width: 100%; margin-top: 5px; }
        button.stats { background: #17a2b8; width: 100%; margin-top: 5px; }
        button.backup { background: #6c757d; }
        button.restore { background: #6610f2; }
        button.btn-manual { background: #6610f2; flex: 0.4; }
        
        button.gist-btn { background: #333; color: white; display: flex; align-items: center; justify-content: center; gap: 5px; }
        button.gist-settings { background: none; border: 1px solid var(--text-color); color: var(--text-color); flex: 0.2; font-size: 1.2em; padding: 0; }

        #reader { width: 100%; margin-bottom: 15px; border-radius: 8px; overflow: hidden; background: black; }
        #searchInput { padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 16px; margin-top: 15px; }

        #scan-list { list-style: none; padding: 0; max-height: 350px; overflow-y: auto; }
        #scan-list li { padding: 12px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        
        .item-left { display: flex; align-items: center; gap: 10px; flex: 1; overflow: hidden; }
        .qty-badge { background: var(--highlight); color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.9em; font-weight: bold; min-width: 25px; text-align: center; }
        .item-info { display: flex; flex-direction: column; overflow: hidden; }
        .code-text { font-weight: bold; font-size: 1.1em; color: var(--highlight); }
        .name-text { font-size: 0.95em; color: var(--text-color); font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .timestamp { font-size: 0.75em; opacity: 0.6; }
        
        .btn-controls { display: flex; gap: 5px; }
        .btn-small { padding: 5px 10px; font-size: 14px; border-radius: 4px; }
        .btn-edit { background: #6f42c1; } 
        .btn-plus { background: var(--highlight); }
        .btn-minus { background: #ffc107; color: black; }
        .btn-del { background: #dc3545; }

        #notification { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 50px; padding: 16px; position: fixed; z-index: 1000; left: 50%; top: 30px; transform: translateX(-50%); opacity: 0; transition: 0.3s; }
        #notification.show { visibility: visible; opacity: 1; top: 50px; }
        #notification.success { background-color: #28a745; }
        #notification.update { background-color: #17a2b8; } 
        #notification.error { background-color: #dc3545; }

        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background-color: var(--card-bg); padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; text-align: center; color: var(--text-color); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .stat-box { background: var(--item-bg-odd); padding: 10px; margin: 10px 0; border-radius: 8px; }
        .stat-value { font-size: 1.5em; font-weight: bold; color: var(--highlight); }
        .stat-label { font-size: 0.9em; opacity: 0.8; }
        .close-modal { margin-top: 15px; background: #dc3545; }
        .save-modal { margin-top: 15px; background: #28a745; }
    </style>
</head>
<body>

<div id="notification">Bildirim</div>

<div id="statsModal" class="modal">
    <div class="modal-content">
        <h3>üìä Klas√∂r Analizi</h3>
        <h4 id="modalFolderName" style="margin:0; opacity:0.7"></h4>
        <div class="stat-box"><div class="stat-value" id="statUnique">0</div><div class="stat-label">√áe≈üit Barkod</div></div>
        <div class="stat-box"><div class="stat-value" id="statTotal">0</div><div class="stat-label">Toplam Adet</div></div>
        <button class="close-modal" onclick="closeModal('statsModal')">Kapat</button>
    </div>
</div>

<div id="gistModal" class="modal">
    <div class="modal-content">
        <h3>‚òÅÔ∏è GitHub Gist Ayarlarƒ±</h3>
        <p style="font-size:0.9em; opacity:0.8;">GitHub Token'ƒ±nƒ±zƒ± giriniz.</p>
        <input type="password" id="gistTokenInput" placeholder="ghp_xxxxxxxxxxxxxxxxx">
        <input type="text" id="gistIdInput" placeholder="Gist ID" readonly style="background: #eee; cursor: not-allowed;">
        <button class="save-modal" onclick="saveGistSettings()">Kaydet</button>
        <button class="close-modal" onclick="closeModal('gistModal')">ƒ∞ptal</button>
    </div>
</div>

<div class="container">
    <div class="header">
        <h2>üì¶ Barkod Master <small>v9</small></h2>
        <button class="theme-toggle" onclick="toggleTheme()">üåô</button>
    </div>

    <div class="controls">
        <div class="row">
            <select id="folderSelect" onchange="loadScans()"></select>
            <button onclick="clearList()" class="clear-list" title="Listeyi Temizle">üßπ</button>
            <button onclick="deleteFolder()" class="delete-folder" title="Klas√∂r√º Sil">üóëÔ∏è</button>
        </div>
        <div class="checkbox-container">
            <input type="checkbox" id="allowDuplicates" onchange="saveCheckboxState()">
            <label for="allowDuplicates">Yinelenenleri Ekle (Adet Modu)</label>
        </div>
        <div class="row">
            <input type="text" id="newFolderInput" placeholder="Yeni Klas√∂r (√ñrn: Raf_A)">
            <button onclick="addFolder()">+ Klas√∂r</button>
        </div>
    </div>

    <div id="reader"></div>

    <div class="row" style="margin-top: 10px;">
        <input type="text" id="manualCodeInput" placeholder="Barkod..." style="flex: 2;" onkeypress="handleManualEnter(event)">
        <input type="number" id="manualQtyInput" placeholder="Adet" value="1" style="flex: 0.6; min-width: 60px;" onkeypress="handleManualEnter(event)">
        <button onclick="addManualCode()" class="btn-manual">Ekle</button>
    </div>

    <input type="text" id="searchInput" placeholder="üîç Listede Ara..." onkeyup="filterList()">

    <div class="row" style="margin-top: 15px;">
        <button onclick="showStats()" class="stats">üìä Analiz & √ñzet</button>
        <button onclick="exportToCSV()" class="export">üìÇ Excel ƒ∞ndir</button>
    </div>

    <div style="border-top: 1px solid var(--border-color); margin-top: 15px; padding-top: 10px;">
        <p style="margin: 0 0 5px 0; font-size: 0.85em; opacity: 0.7; text-align: center;">Yedekleme & Geri Y√ºkleme</p>
        <div class="row">
            <button onclick="backupData()" class="backup">üíæ Yerel Yedek</button>
            <button onclick="document.getElementById('restoreInput').click()" class="restore">‚ôªÔ∏è Yerel Y√ºkle</button>
            <input type="file" id="restoreInput" style="display:none" onchange="restoreData(this)">
        </div>
        <div class="row">
            <button onclick="showGistModal()" class="gist-settings" title="Gist Ayarlarƒ±">‚öôÔ∏è</button>
            <button onclick="uploadToGist()" class="gist-btn">‚òÅÔ∏è Buluta G√∂nder</button>
            <button onclick="downloadFromGist()" class="gist-btn">‚òÅÔ∏è Buluttan √áek</button>
        </div>
    </div>

    <h3>√úr√ºnler (<span id="count">0</span>)</h3>
    <ul id="scan-list"></ul>
</div>

<script>
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if ('serviceWorker' in navigator) { window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js')); }

    let folders = JSON.parse(localStorage.getItem('folders')) || ['Genel'];
    let scans = JSON.parse(localStorage.getItem('scans')) || []; 
    let productNames = JSON.parse(localStorage.getItem('productNames')) || {}; 
    
    let gistToken = localStorage.getItem('gistToken') || '';
    let gistId = localStorage.getItem('gistId') || '';

    let currentFolder = folders[0];
    let scanCooldown = false;

    if (localStorage.getItem('theme') === 'dark') { document.body.setAttribute('data-theme', 'dark'); }
    const savedCheckbox = localStorage.getItem('allowDuplicates');
    document.getElementById('allowDuplicates').checked = savedCheckbox !== 'false';

    function init() {
        const select = document.getElementById('folderSelect');
        select.innerHTML = '';
        folders.forEach(f => {
            let opt = document.createElement('option');
            opt.value = f; opt.innerText = f;
            if(f === currentFolder) opt.selected = true;
            select.appendChild(opt);
        });
        loadScans();
        document.getElementById('gistIdInput').value = gistId;
        document.getElementById('gistTokenInput').value = gistToken;
    }

    const html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
    
    function processCode(code, quantityToAdd = 1) {
        if (!code) return;
        currentFolder = document.getElementById('folderSelect').value;
        const allowDuplicates = document.getElementById('allowDuplicates').checked;
        const existingIndex = scans.findIndex(s => s.folder === currentFolder && s.code === code);
        
        const name = productNames[code] || "";
        const displayName = name ? name : code;
        quantityToAdd = parseInt(quantityToAdd); if(isNaN(quantityToAdd) || quantityToAdd < 1) quantityToAdd = 1;

        if (existingIndex !== -1) {
            if (allowDuplicates) {
                scans[existingIndex].qty = (scans[existingIndex].qty || 1) + quantityToAdd;
                scans[existingIndex].time = new Date().toLocaleString('tr-TR');
                const updatedItem = scans.splice(existingIndex, 1)[0];
                scans.unshift(updatedItem);
                showToast(`üì¶ Adet Arttƒ±: ${displayName} (+${quantityToAdd})`, "update");
                playBeep(600);
            } else {
                showToast(`‚ö†Ô∏è HATA: Zaten var! (${displayName})`, "error");
                if(navigator.vibrate) navigator.vibrate([100, 50, 100]); return;
            }
        } else {
            const newScan = { folder: currentFolder, code: code, time: new Date().toLocaleString('tr-TR'), qty: quantityToAdd };
            scans.unshift(newScan);
            showToast(`‚úÖ Eklendi: ${displayName} (x${quantityToAdd})`, "success");
            playBeep(880);
        }
        saveData(); loadScans();
        if(navigator.vibrate && (existingIndex === -1 || allowDuplicates)) navigator.vibrate(100);
    }

    function onScanSuccess(decodedText) {
        if (scanCooldown) return;
        scanCooldown = true; setTimeout(() => { scanCooldown = false; }, 1200);
        processCode(decodedText, 1);
    }
    html5QrcodeScanner.render(onScanSuccess);

    function addManualCode() {
        const inputCode = document.getElementById('manualCodeInput');
        const inputQty = document.getElementById('manualQtyInput');
        const code = inputCode.value.trim();
        const qty = parseInt(inputQty.value) || 1; 
        if (code) { processCode(code, qty); inputCode.value = ''; inputQty.value = '1'; inputCode.focus(); } else { alert("Barkod yazƒ±n."); }
    }
    function handleManualEnter(event) { if (event.key === "Enter") addManualCode(); }
    function renameItem(code) {
        const currentName = productNames[code] || "";
        const newName = prompt(`"${code}" i√ßin isim giriniz:`, currentName);
        if (newName !== null) { productNames[code] = newName.trim(); saveData(); loadScans(); }
    }

    // --- GIST ƒ∞≈ûLEMLERƒ∞ ---
    function showGistModal() { document.getElementById('gistModal').style.display = "flex"; }
    function closeModal(id) { document.getElementById(id).style.display = "none"; }
    function saveGistSettings() {
        gistToken = document.getElementById('gistTokenInput').value.trim();
        if(!gistToken) { alert("Token bo≈ü!"); return; }
        localStorage.setItem('gistToken', gistToken);
        showToast("Ayarlar Kaydedildi", "success"); closeModal('gistModal');
    }
    async function uploadToGist() {
        if (!gistToken) { alert("√ñnce Token giriniz!"); showGistModal(); return; }
        showToast("Buluta g√∂nderiliyor...", "update");
        try {
            let url = "https://api.github.com/gists";
            let method = "POST";
            if (gistId) { url += "/" + gistId; method = "PATCH"; }
            
            // Temizlik yaparak g√∂nderelim (Gereksiz isimleri temizle)
            cleanUpProductNames(); 

            const response = await fetch(url, {
                method: method,
                headers: { "Authorization": `token ${gistToken}`, "Accept": "application/vnd.github.v3+json", "Content-Type": "application/json" },
                body: JSON.stringify({ description: "Barkod Master Otomatik Yedek", public: false, files: { "barkod_master_backup.json": { content: JSON.stringify({ folders, scans, productNames }, null, 2) } } })
            });
            if (!response.ok) throw new Error(response.status);
            const data = await response.json();
            gistId = data.id; localStorage.setItem('gistId', gistId); document.getElementById('gistIdInput').value = gistId;
            showToast("‚úÖ Buluta Yedeklendi!", "success");
        } catch (error) { alert("Hata: " + error.message); }
    }
    async function downloadFromGist() {
        if (!gistToken) { alert("Token giriniz!"); showGistModal(); return; }
        if (!gistId) { 
            const manuelId = prompt("Gist ID yok. Manuel giriniz:"); 
            if(!manuelId) return; 
            gistId = manuelId; 
        }
        showToast("Buluttan √ßekiliyor...", "update");
        try {
            const response = await fetch(`https://api.github.com/gists/${gistId}`, { headers: { "Authorization": `token ${gistToken}` } });
            if (!response.ok) throw new Error("Hata");
            const data = await response.json();
            if (data.files && data.files["barkod_master_backup.json"]) {
                const content = JSON.parse(data.files["barkod_master_backup.json"].content);
                if(confirm("Telefondaki veriler silinip bulut yedeƒüi y√ºklenecek?")) {
                    folders = content.folders; scans = content.scans; productNames = content.productNames || {};
                    saveData(); init(); showToast("‚ôªÔ∏è Y√ºklendi!", "success"); localStorage.setItem('gistId', gistId);
                }
            } else { alert("Yedek bulunamadƒ±."); }
        } catch (error) { alert("Hata: " + error.message); }
    }

    // --- TEMƒ∞ZLƒ∞K MANTIƒûI ---
    function cleanUpProductNames() {
        // Aktif kullanƒ±lan t√ºm kodlarƒ± bul
        const activeCodes = new Set(scans.map(s => s.code));
        // productNames i√ßindeki her bir anahtarƒ± kontrol et
        Object.keys(productNames).forEach(code => {
            if (!activeCodes.has(code)) {
                delete productNames[code]; // Kullanƒ±lmƒ±yorsa sil
            }
        });
    }

    // --- STANDART FONKSƒ∞YONLAR ---
    function showStats() {
        currentFolder = document.getElementById('folderSelect').value;
        const filtered = scans.filter(s => s.folder === currentFolder);
        document.getElementById('modalFolderName').innerText = currentFolder;
        document.getElementById('statUnique').innerText = filtered.length;
        document.getElementById('statTotal').innerText = filtered.reduce((acc, curr) => acc + (curr.qty || 1), 0);
        document.getElementById('statsModal').style.display = "flex";
    }
    function clearList() {
        currentFolder = document.getElementById('folderSelect').value;
        if(confirm(`"${currentFolder}" i√ßi temizlensin mi?`)) {
            scans = scans.filter(s => s.folder !== currentFolder);
            saveData(); loadScans(); showToast("Liste temizlendi", "update");
        }
    }
    function saveCheckboxState() { localStorage.setItem('allowDuplicates', document.getElementById('allowDuplicates').checked); }
    function updateQty(code, change) {
        const index = scans.findIndex(s => s.folder === currentFolder && s.code === code);
        if (index !== -1) {
            scans[index].qty = (scans[index].qty || 1) + change;
            if (scans[index].qty <= 0) { if(confirm("Silinsin mi?")) scans.splice(index, 1); else scans[index].qty = 1; }
            saveData(); loadScans();
        }
    }
    function deleteItem(code) {
        if(confirm(`"${code}" silinsin mi?`)) {
            scans = scans.filter(s => !(s.folder === currentFolder && s.code === code));
            saveData(); loadScans();
        }
    }
    function loadScans() {
        currentFolder = document.getElementById('folderSelect').value;
        const list = document.getElementById('scan-list');
        list.innerHTML = '';
        const term = document.getElementById('searchInput').value.toLowerCase();
        const filtered = scans.filter(s => {
            const name = (productNames[s.code] || "").toLowerCase();
            return s.folder === currentFolder && (s.code.toLowerCase().includes(term) || name.includes(term));
        });
        document.getElementById('count').innerText = filtered.length;
        filtered.forEach(s => {
            const pName = productNames[s.code] || ""; 
            let li = document.createElement('li');
            li.innerHTML = `
                <div class="item-left"><span class="qty-badge">x${s.qty||1}</span>
                <div class="item-info">${pName ? `<span class="name-text">${pName}</span>` : ''}
                <span class="code-text" style="${pName ? 'font-size:0.85em; opacity:0.8; font-weight:normal;' : ''}">${s.code}</span>
                <span class="timestamp">${s.time}</span></div></div>
                <div class="btn-controls"><button onclick="renameItem('${s.code}')" class="btn-small btn-edit">‚úé</button>
                <button onclick="updateQty('${s.code}',1)" class="btn-small btn-plus">+</button>
                <button onclick="updateQty('${s.code}',-1)" class="btn-small btn-minus">-</button>
                <button onclick="deleteItem('${s.code}')" class="btn-small btn-del">üóëÔ∏è</button></div>`;
            list.appendChild(li);
        });
    }
    function filterList() { loadScans(); }
    function exportToCSV() {
        currentFolder = document.getElementById('folderSelect').value;
        const filtered = scans.filter(s => s.folder === currentFolder);
        if(filtered.length === 0) { alert("Bo≈ü!"); return; }
        let csv = "data:text/csv;charset=utf-8,\uFEFFBarkod;Urun_Adi;Adet;Tarih;Klas√∂r\r\n";
        filtered.forEach(r => { csv += `${r.code};${(productNames[r.code]||"").replace(/;/g, " ")};${r.qty||1};${r.time};${r.folder}\r\n`; });
        const link = document.createElement("a"); link.href = encodeURI(csv); link.download = `Stok_${currentFolder}.csv`;
        document.body.appendChild(link); link.click(); document.body.removeChild(link);
    }
    function saveData() { 
        cleanUpProductNames(); // Kaydetmeden √∂nce temizlik yap
        localStorage.setItem('scans', JSON.stringify(scans)); 
        localStorage.setItem('folders', JSON.stringify(folders));
        localStorage.setItem('productNames', JSON.stringify(productNames));
    }
    function addFolder() { 
        const name = document.getElementById('newFolderInput').value.trim();
        if (name && !folders.includes(name)) { folders.push(name); saveData(); currentFolder=name; document.getElementById('newFolderInput').value=''; init(); } 
    }
    function deleteFolder() { 
        if(confirm("Silinsin mi?")) { 
            folders = folders.filter(f=>f!==document.getElementById('folderSelect').value); 
            scans=scans.filter(s=>s.folder!==currentFolder); 
            if(folders.length===0) folders=['Genel']; currentFolder=folders[0]; saveData(); init(); 
        } 
    }
    function backupData() {
        const blob = new Blob([JSON.stringify({folders, scans, productNames})], {type: "application/json"});
        const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = "Full_Yedek.json"; document.body.appendChild(link); link.click(); document.body.removeChild(link);
    }
    function restoreData(input) {
        const file = input.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = e => { try { const d=JSON.parse(e.target.result); folders=d.folders; scans=d.scans; if(d.productNames) productNames=d.productNames; saveData(); init(); showToast("Y√ºklendi!","success"); } catch(err){alert("Hata");} };
        reader.readAsText(file);
    }
    function playBeep(freq) {
        if(audioCtx.state==='suspended') audioCtx.resume();
        const o=audioCtx.createOscillator(); const g=audioCtx.createGain();
        o.connect(g); g.connect(audioCtx.destination);
        o.type="square"; o.frequency.value=freq; g.gain.value=0.1;
        o.start(); setTimeout(()=>o.stop(), 150);
    }
    function showToast(msg, type) { const x=document.getElementById("notification"); x.className="show "+type; x.innerText=msg; setTimeout(()=>x.className="", 2000); }
    function toggleTheme() {
        if(document.body.getAttribute('data-theme')==='dark') { document.body.removeAttribute('data-theme'); localStorage.setItem('theme','light'); } 
        else { document.body.setAttribute('data-theme','dark'); localStorage.setItem('theme','dark'); }
    }
    window.onclick = function(event) { if (event.target == document.getElementById('statsModal')) closeModal('statsModal'); if (event.target == document.getElementById('gistModal')) closeModal('gistModal'); }

    init();
</script>
</body>
</html>